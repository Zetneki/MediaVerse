BEGIN;


CREATE TABLE IF NOT EXISTS public.genre_cache
(
    source text COLLATE pg_catalog."default" NOT NULL,
    id text COLLATE pg_catalog."default" NOT NULL,
    name text COLLATE pg_catalog."default" NOT NULL,
    last_updated timestamp without time zone DEFAULT now(),
    CONSTRAINT genre_cache_pkey PRIMARY KEY (source, id)
);

CREATE TABLE IF NOT EXISTS public.movie_cache
(
    id bigint NOT NULL,
    title text COLLATE pg_catalog."default" NOT NULL,
    overview text COLLATE pg_catalog."default",
    release_date date,
    poster_path text COLLATE pg_catalog."default",
    backdrops text[] COLLATE pg_catalog."default",
    trailer text COLLATE pg_catalog."default",
    vote_average numeric,
    genres jsonb,
    popularity numeric,
    runtime integer,
    homepage text COLLATE pg_catalog."default",
    similar_movies jsonb,
    last_updated timestamp without time zone DEFAULT now(),
    CONSTRAINT movie_cache_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.movie_page_cache
(
    page integer NOT NULL,
    category text COLLATE pg_catalog."default" NOT NULL,
    movie_ids bigint[] NOT NULL,
    last_updated timestamp without time zone DEFAULT now(),
    total_results bigint,
    CONSTRAINT movie_page_cache_pkey PRIMARY KEY (page, category)
);

CREATE TABLE IF NOT EXISTS public.series_cache
(
    id bigint NOT NULL,
    name text COLLATE pg_catalog."default" NOT NULL,
    overview text COLLATE pg_catalog."default",
    first_air_date date,
    poster_path text COLLATE pg_catalog."default",
    backdrops text[] COLLATE pg_catalog."default",
    trailer text COLLATE pg_catalog."default",
    vote_average numeric,
    genres jsonb,
    popularity numeric,
    total_seasons integer,
    total_episodes integer,
    seasons jsonb,
    homepage text COLLATE pg_catalog."default",
    similar_series jsonb,
    last_updated timestamp without time zone DEFAULT now(),
    CONSTRAINT series_cache_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.series_page_cache
(
    page integer NOT NULL,
    category text COLLATE pg_catalog."default" NOT NULL,
    series_ids bigint[] NOT NULL,
    last_updated timestamp without time zone DEFAULT now(),
    total_results bigint,
    CONSTRAINT series_page_cache_pkey PRIMARY KEY (page, category)
);

CREATE TABLE IF NOT EXISTS public.user_movie_progress
(
    user_id integer NOT NULL,
    movie_id bigint NOT NULL,
    status text COLLATE pg_catalog."default",
    last_watched timestamp without time zone,
    CONSTRAINT user_movie_progress_pkey PRIMARY KEY (user_id, movie_id)
);

CREATE TABLE IF NOT EXISTS public.user_profile
(
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    username text COLLATE pg_catalog."default" NOT NULL,
    created_at timestamp without time zone DEFAULT now(),
    wallet_address text COLLATE pg_catalog."default",
    wallet_verified boolean DEFAULT false,
    password_hash text COLLATE pg_catalog."default" NOT NULL,
    token_version integer DEFAULT 0,
    active_theme text COLLATE pg_catalog."default" DEFAULT 'indigo'::text,
    active_dark_light_mode text COLLATE pg_catalog."default" DEFAULT 'system'::text,
    CONSTRAINT user_profile_pkey PRIMARY KEY (id),
    CONSTRAINT user_profile_username_key UNIQUE (username),
    CONSTRAINT user_profile_wallet_address_key UNIQUE (wallet_address)
);

CREATE TABLE IF NOT EXISTS public.user_series_progress
(
    user_id integer NOT NULL,
    series_id bigint NOT NULL,
    current_season integer DEFAULT 0,
    current_episode integer DEFAULT 0,
    last_watched timestamp without time zone,
    status text COLLATE pg_catalog."default",
    CONSTRAINT user_series_progress_pkey PRIMARY KEY (user_id, series_id)
);

CREATE TABLE IF NOT EXISTS public.user_themes
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    name text COLLATE pg_catalog."default" NOT NULL,
    created_at timestamp without time zone DEFAULT now(),
    CONSTRAINT user_themes_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.user_movie_progress
    ADD CONSTRAINT user_movie_progress_movie_id_fkey FOREIGN KEY (movie_id)
    REFERENCES public.movie_cache (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS idx_user_movie_progress_movie_id
    ON public.user_movie_progress(movie_id);


ALTER TABLE IF EXISTS public.user_movie_progress
    ADD CONSTRAINT user_movie_progress_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.user_profile (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_user_movie_progress_user_id
    ON public.user_movie_progress(user_id);


ALTER TABLE IF EXISTS public.user_series_progress
    ADD CONSTRAINT user_series_progress_series_id_fkey FOREIGN KEY (series_id)
    REFERENCES public.series_cache (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS idx_user_series_progress_series_id
    ON public.user_series_progress(series_id);


ALTER TABLE IF EXISTS public.user_series_progress
    ADD CONSTRAINT user_series_progress_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.user_profile (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_user_series_progress_user_id
    ON public.user_series_progress(user_id);


ALTER TABLE IF EXISTS public.user_themes
    ADD CONSTRAINT user_themes_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.user_profile (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_user_themes_user_id
    ON public.user_themes(user_id);

END;


CREATE OR REPLACE FUNCTION insert_default_theme()
RETURNS trigger AS $$
BEGIN
  INSERT INTO user_themes (user_id, name)
  VALUES (NEW.id, 'indigo');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER user_default_theme
AFTER INSERT ON user_profile
FOR EACH ROW
EXECUTE FUNCTION insert_default_theme();